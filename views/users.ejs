<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
    <style>
        body {
            background-color: #091a23;
            color: #eee;
        }

        img {
            height: 50px;
            width: 50px;
        }

    </style>
</head>

<body>
<p>

<form url="./" method="get" id="filterForm">
    <div>gender:</div>
    <div><label>male:<input type="checkbox" name="gender" value="male"
                    <% if(query.gender == 'male'){ %>
                            checked
                    <% } %>
                    /></label></div>
    <div><label>female:<input type="checkbox" name="gender" value="female"
                    <% if(query.gender == 'female'){ %>
                              checked
                    <% } %>
                    /></label></div>
    <div><label>limit:
            <select name="limit">
                <option value="10"
                        <% if(query.limit == '10'){ %>
                        selected
                        <% } %>
                        >10
                </option>
                <option value="20"
                        <% if(query.limit == '20'){ %>
                        selected
                        <% } %>
                        >20
                </option>
                <option value="30"
                        <% if(query.limit == '30'){ %>
                        selected
                        <% } %>
                        >30
                </option>
                <option value="40"
                        <% if(query.limit == '40'){ %>
                        selected
                        <% } %>
                        >40
                </option>
            </select></label></div>
    <input type="submit" value="search">
</form>
</p>
<div id="container">
</div>


<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    (function () {
        var picUrlPre = '/users/pic?url=';


        var $filterForm = $('#filterForm');
        $filterForm.on('submit', function(){
            render();
            return false;
        });


        function loadImage(list, callback){
            var count = list.length;
            var checkLoaded = function(){
                count--;
                if(count<=0){
                    callback(list);
                }
            }
            list.forEach(function(item){
                var smPic = getSmallImg(item.avatar);
                item.avatar_l = smPic;
                var img = new Image();
                img.onload = function(){
                    checkLoaded();
                }
                img.onerror = function(){
                    checkLoaded();
                }
                img.src = picUrlPre+smPic;
            });

        }

        var maxTime = 3;
        var isRandering = false;
        var $container = $('#container');
        function render(){
            if(isRandering){
                return ;
            }
            var max = 0;
            $container.find('img').each(function(){
                var $this = $(this);
                var time = (maxTime*Math.random()).toFixed(2)*1;
                if(max<time){
                    max = time;
                }
                $this.animate({opacity:0}, time*1000);
            });

            isRandering = true;
            $.get('/users/list', $filterForm.serialize(), function(res){
                var list = res.data.list;
                var html = '';
                var images = [];
                loadImage(list, function(newList){
                    newList.forEach(function(item){
                        html += ' <img src="'+picUrlPre+item.avatar_l +'" title="'+item.name +'">';
                    });


                    setTimeout(function(){
                        $container.html(html);
                        isRandering = false;
                    }, max*1000);
                });

            });
        }

        render();

        function getSmallImg(src){
            var cache = src.split('.');
            var ext = cache.pop();
            var fileName = cache.pop() + '_l';
            cache = cache.concat([fileName, ext]);
            return cache.join('.');
        }

    })();
</script>
</body>
</html>
